<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>–ú–∏–π–∫–∏ —Ü–∏—Å—Ç–µ—Ä–Ω</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Roboto, sans-serif;
  text-align: center;
  padding: 10px;
  background: #f0f2f5;
  margin: 0;
  overflow-x: hidden;
}
h1 { font-size: 18px; margin: 5px 0; }
h2 { font-size: 16px; margin: 5px 0; }
p  { font-size: 14px; margin: 5px 0; color:#0056b3; }

.btn {
  margin: 3px;
  padding: 6px 12px;
  font-size: 14px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  overflow: hidden;
  position: relative;
}
.like { background:#1c7430; color:#fff; font-size:16px; padding:10px 14px;}
.like:hover { background:#155d27; }
.dislike { background:#b02a37; color:#fff; font-size:16px; padding:10px 14px;}
.dislike:hover { background:#7a1c26; }

.btn-main {
  display:block;
  width:80%;
  max-width:250px;
  margin:5px auto;
  padding:10px 0;
  background:#0088cc;
  color:#fff;
  border-radius:6px;
  font-size:15px;
  cursor:pointer;
  border:none;
  font-weight:bold;
  transition: all 0.3s ease;
  overflow:hidden;
  position:relative;
}
.btn-main:hover { background:#005f8d; }

textarea,input {
  width:80%;
  max-width:250px;
  padding:6px;
  font-size:14px;
  border-radius:4px;
  border:1px solid #ccc;
  margin-bottom:5px;
}
#commentsList {
  margin-top:5px;
  text-align:left;
  max-width:500px;
  margin-left:auto;
  margin-right:auto;
}
.comment {
  background:#e0e0e0;
  padding:10px;
  margin-bottom:5px;
  border-radius:4px;
  position:relative;
}
.comment button {
  margin-left:3px;
  padding:2px 4px;
  font-size:10px;
  cursor:pointer;
}
.comment .comment-actions {
  position:absolute;
  top:5px;
  right:5px;
}
.comment .comment-like {
  font-size:12px;
  margin-left:5px;
  background:#007bff;
  color:#fff;
  border:none;
  padding:2px 6px;
  border-radius:4px;
  cursor:pointer;
}
.comment .comment-like.active { background:#0056b3; }
.comment .comment-time { font-size:11px; color:#555; margin-top:3px; }

.version {
  position:fixed;
  bottom:5px;
  left:50%;
  transform:translateX(-50%);
  font-size:10px;
  color:#888;
  background:rgba(255,255,255,0.7);
  padding:2px 4px;
  border-radius:3px;
}

.modal {
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.4);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.3s ease;
}
.modal.show { opacity:1; pointer-events:auto; }
.modal-content {
  background:#fff;
  padding:20px 30px;
  border-radius:10px;
  box-shadow:0 4px 10px rgba(0,0,0,0.3);
  text-align:center;
  max-width:300px;
  animation:pop 0.3s ease;
}
@keyframes pop {
  from{transform:scale(0.8);opacity:0;}
  to{transform:scale(1);opacity:1;}
}
.modal-content h3 { margin:0 0 10px; color:#28a745; }
.modal-content button {
  background:#28a745;
  color:#fff;
  padding:6px 12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
.modal-content button:hover { background:#1e7e34; }

.active-like { background:#1e7e34 !important; }
.active-dislike { background:#a71d2a !important; }

/* üîπ –°–∏–Ω—å–æ-—Ñ—ñ–æ–ª–µ—Ç–æ–≤—ñ –∫–Ω–æ–ø–∫–∏ */
.purple-btn {
  background: linear-gradient(135deg, #6f42c1, #007bff);
  color: #fff !important;
  font-weight: bold;
  border: none;
  border-radius: 10px;
  padding: 8px 14px;
  font-size: 13px;
  display: inline-block;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}
.purple-btn:hover {
  background: linear-gradient(135deg, #5a32a3, #0056b3);
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 5px 12px rgba(0,0,0,0.25);
}
.purple-btn:active {
  transform: scale(0.96);
  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
</style>
</head>
<body>

<h1>–ú–∏–π–∫–∏ —Ü–∏—Å—Ç–µ—Ä–Ω</h1>
<p>–ó–∞–ª–∏—à–∞–π—Ç–µ –≤—ñ–¥–≥—É–∫–∏ –ø—Ä–æ –º–∏–π–∫–∏ –≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—è—Ö. –ù–æ–≤—ñ –º–∏–π–∫–∏ —Ç–µ–∂ –º–æ–∂–Ω–∞ –ø–∏—Å–∞—Ç–∏ –≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—è—Ö —ñ –≤–æ–Ω–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –Ω–∞ –∫–∞—Ä—Ç—É.</p>

<!-- –ü–æ–ª—è –¥–ª—è –≤—Ö–æ–¥—É -->
<div id="loginSection">
  <input type="text" id="userNameInput" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è">
  <button class="btn btn-main" onclick="signInAnon()">–£–≤—ñ–π—Ç–∏</button>
  <input type="password" id="adminKey" placeholder="–ö–ª—é—á –∞–¥–º—ñ–Ω–∞">
  <button class="btn btn-main" onclick="signInAdmin()">–£–≤—ñ–π—Ç–∏ —è–∫ –∞–¥–º—ñ–Ω</button>
</div>

<h2 id="userDisplay" style="margin-top:10px; font-weight:bold;"></h2>

<!-- üîπ –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞—Ä—Ç–∏ –Ω–∞–¥ –∫–æ–º–µ–Ω—Ç–∞—Ä—è–º–∏ -->
<a id="mapLink" class="purple-btn" href="map.html" style="display:none; margin-bottom:10px;">üó∫ –ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–∞—Ä—Ç–∏</a>

<h2></h2>
<button class="btn like" onclick="vote('like')" disabled id="likeBtn">üëç</button>
<button class="btn dislike" onclick="vote('dislike')" disabled id="dislikeBtn">üëé</button>
<div class="counters">–õ–∞–π–∫–∏: <span id="likeCount">0</span> | –î–∏–∑–ª–∞–π–∫–∏: <span id="dislikeCount">0</span></div>

<h2>–ö–æ–º–µ–Ω—Ç–∞—Ä—ñ</h2>
<textarea id="commentInput" rows="2" placeholder="–í–∞—à –∫–æ–º–µ–Ω—Ç–∞—Ä..." disabled></textarea><br>
<button class="btn btn-main" onclick="sendComment()" disabled>–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
<div id="commentsList"></div>

<!-- üîπ –ö–Ω–æ–ø–∫–∞ –í–∏–π—Ç–∏ -->
<button id="logoutBtn" class="btn btn-main" style="background:#dc3545; display:none;" onclick="logout()">üö™ –í–∏–π—Ç–∏</button>

<!-- üîπ –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å -->
<div id="adminPanel" style="display:none; margin-top:20px; text-align:left; max-width:500px; margin-left:auto; margin-right:auto;">
  <h2>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å: –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h2>
  <table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">
    <thead>
      <tr style="background:#ddd;">
        <th>UID</th>
        <th>–Ü–º‚Äô—è</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–î—ñ—è</th>
      </tr>
    </thead>
    <tbody id="usersTable">
    </tbody>
  </table>
</div>

<div class="version">–ë–µ—Ç–∞-–í–µ—Ä—Å—ñ—è 1.0.0</div>

<div id="successModal" class="modal">
  <div class="modal-content">
    <h3>‚úÖ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3>
    <p id="modalText"></p>
    <button onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCG5mxvBurQdQeSz6dIo-Qd5UJEwnhCxpA",
  authDomain: "miyjky.firebaseapp.com",
  databaseURL: "https://miyjky-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "miyjky",
  storageBucket: "miyjky.firebasestorage.app",
  messagingSenderId: "967414135211",
  appId: "1:967414135211:web:9b3444523a807626dbfaee"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let currentUserUID = null;
let currentUserName = null;
let isAdmin = false;
let modalTimeout;
let lastCommentTimestamp = 0;

// --- –ê–≤—Ç–æ–≤—Ö—ñ–¥ ---
window.onload = function(){
  const savedUID = localStorage.getItem('userUID');
  const savedName = localStorage.getItem('userName');
  const savedAdmin = localStorage.getItem('isAdmin') === 'true';
  if(savedUID && savedName){
    currentUserUID = savedUID;
    currentUserName = savedName;
    isAdmin = savedAdmin;
    enableUI();
    checkUserVote();
  }
}

// --- –í—Ö—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ---
function signInAnon(){
  let name = document.getElementById('userNameInput').value.trim();
  if(!name) return showModal("–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è!");
  firebase.auth().signInAnonymously().then(res=>{
    currentUserUID = res.user.uid;
    currentUserName = name;
    isAdmin = false;
    localStorage.setItem('userUID', currentUserUID);
    localStorage.setItem('userName', name);
    localStorage.setItem('isAdmin', false);
    enableUI();
    checkUserVote();
    showModal("–í–∏ —É–≤—ñ–π—à–ª–∏ —è–∫, "+name);
  });
}

// --- –í—Ö—ñ–¥ –∞–¥–º—ñ–Ω–∞ ---
function signInAdmin(){
  const key = document.getElementById('adminKey').value.trim();
  if(key==="admin123"){
    isAdmin = true;
    firebase.auth().signInAnonymously().then(res=>{
      currentUserUID = res.user.uid;
      currentUserName = "–ê–¥–º—ñ–Ω";
      localStorage.setItem('userUID', currentUserUID);
      localStorage.setItem('userName', currentUserName);
      localStorage.setItem('isAdmin', true);
      enableUI();
      checkUserVote();
      showModal("–í—Ö—ñ–¥ –∞–¥–º—ñ–Ω–∞ —É—Å–ø—ñ—à–Ω–∏–π!");
    });
  } else showModal("‚ùå –ù–µ–≤—ñ—Ä–Ω–∏–π –∫–ª—é—á!");
}

// --- –í–∏–π—Ç–∏ ---
function logout(){
  firebase.auth().signOut().then(()=>{
    localStorage.clear();
    currentUserUID = null;
    currentUserName = null;
    isAdmin = false;
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('likeBtn').disabled = true;
    document.getElementById('dislikeBtn').disabled = true;
    document.querySelector('#commentInput').disabled = true;
    document.querySelector('button[onclick="sendComment()"]').disabled = true;
    document.getElementById('mapLink').style.display = 'none';
    document.getElementById('logoutBtn').style.display = 'none';
    document.getElementById('userDisplay').innerText = '';
    document.getElementById('adminPanel').style.display = 'none';
    showModal("–í–∏ –≤–∏–π—à–ª–∏ –∑ –∞–∫–∞—É–Ω—Ç—É!");
  });
}

// --- –ê–∫—Ç–∏–≤—É—î–º–æ UI ---
function enableUI(){
  if(currentUserUID && currentUserName){
    saveUserInDB();
  }
  document.getElementById('likeBtn').disabled = false;
  document.getElementById('dislikeBtn').disabled = false;
  document.querySelector('#commentInput').disabled = false;
  document.querySelector('button[onclick="sendComment()"]').disabled = false;
  document.getElementById('mapLink').style.display = 'inline-block';
  document.getElementById('logoutBtn').style.display = 'inline-block';
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('userDisplay').innerText = "–í—ñ—Ç–∞—é, " + currentUserName;
  updateCounters();
  if(isAdmin){
    document.getElementById('adminPanel').style.display = 'block';
    loadUsers();
  }
}

// --- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ ---
function showModal(msg){
  document.getElementById("modalText").innerText = msg;
  const modal = document.getElementById("successModal");
  modal.classList.add("show");
  clearTimeout(modalTimeout);
  modalTimeout = setTimeout(()=>closeModal(),3000);
}
function closeModal(){ document.getElementById("successModal").classList.remove("show"); }

// --- –ì–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è ---
function updateCounters(){
  db.ref('votes').once('value').then(snap=>{
    const d = snap.val() || {likes:0, dislikes:0};
    document.getElementById('likeCount').innerText = d.likes||0;
    document.getElementById('dislikeCount').innerText = d.dislikes||0;
  });
}
function vote(type){
  if(!currentUserUID) return showModal("–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!");
  db.ref('users/'+currentUserUID).once('value').then(uSnap=>{
    if(uSnap.exists() && uSnap.val().blocked) return showModal("–í–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ!");
    const ref = db.ref('votes/users/'+currentUserUID);
    ref.once('value').then(snap=>{
      if(snap.exists()) return showModal("–í–∏ –≤–∂–µ –≥–æ–ª–æ—Å—É–≤–∞–ª–∏!");
      ref.set(type);
      db.ref('votes').transaction(d=>{
        if(!d) d={likes:0,dislikes:0,users:{}};
        if(type==='like') d.likes=(d.likes||0)+1;
        if(type==='dislike') d.dislikes=(d.dislikes||0)+1;
        return d;
      });
      markVoted(type);
    });
  });
}
db.ref('votes').on('value', snap=>{
  const d = snap.val()||{likes:0,dislikes:0};
  document.getElementById('likeCount').innerText = d.likes||0;
  document.getElementById('dislikeCount').innerText = d.dislikes||0;
});
function checkUserVote(){
  if(!currentUserUID) return;
  db.ref('votes/users/'+currentUserUID).once('value').then(snap=>{
    if(snap.exists()) markVoted(snap.val());
  });
}
function markVoted(type){
  document.getElementById('likeBtn').disabled = true;
  document.getElementById('dislikeBtn').disabled = true;
  if(type==='like') document.getElementById('likeBtn').classList.add('active-like');
  if(type==='dislike') document.getElementById('dislikeBtn').classList.add('active-dislike');
}

// --- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ ---
function sendComment(){
  if(!currentUserUID) return showModal("–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!");
  db.ref('users/'+currentUserUID).once('value').then(uSnap=>{
    if(uSnap.exists() && uSnap.val().blocked) return showModal("–í–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ!");
    const t = document.getElementById('commentInput').value.trim();
    if(!t) return showModal("–í–≤–µ–¥—ñ—Ç—å –∫–æ–º–µ–Ω—Ç–∞—Ä!");
    db.ref('comments').push().set({
      uid: currentUserUID,
      name: currentUserName,
      text: t,
      likes: 0,
      timestamp: Date.now()
    });
    document.getElementById('commentInput').value='';
  });
}

// --- –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ ---
db.ref('comments').on('value', snap=>{
  const latestComments = snap.val()||{};
  renderComments(latestComments);

  // –û–Ω–æ–≤–ª—é—î–º–æ lastCommentTimestamp –±–µ–∑ –∑–≤—É–∫—É
  const timestamps = Object.values(latestComments).map(c=>c.timestamp);
  lastCommentTimestamp = timestamps.length ? Math.max(...timestamps) : 0;
});

function renderComments(c){
  const div = document.getElementById('commentsList');
  div.innerHTML='';
  Object.entries(c).sort((a,b)=>a[1].timestamp-b[1].timestamp).forEach(([k,cm])=>{
    const d = document.createElement('div'); 
    d.className='comment';
    let actions = '';
    actions += `<button class="comment-like" onclick="likeComment('${k}', this)">üëç ${cm.likes||0}</button>`;
    if(isAdmin){
      actions += `<div class="comment-actions">
        <button onclick="editComment('${k}')">‚úèÔ∏è</button>
        <button onclick="deleteComment('${k}')">üóë</button>
      </div>`;
    }
    const dateStr = new Date(cm.timestamp).toLocaleString();
    d.innerHTML = `<strong>${cm.name}:</strong> ${cm.text} <div class="comment-time">${dateStr}</div> ${actions}`;
    div.appendChild(d);
  });
}

// --- –õ–∞–π–∫ –∫–æ–º–µ–Ω—Ç–∞—Ä—è ---
function likeComment(key, btn){
  if(!currentUserUID) return showModal("–í–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ!");
  db.ref('users/'+currentUserUID).once('value').then(uSnap=>{
    if(uSnap.exists() && uSnap.val().blocked) return showModal("–í–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω—ñ!");
    const userLikeRef = db.ref('commentLikes/'+key+'/'+currentUserUID);
    userLikeRef.once('value').then(snap=>{
      if(snap.exists()) return showModal("–í–∏ –≤–∂–µ –ª–∞–π–∫–Ω—É–ª–∏ —Ü–µ–π –∫–æ–º–µ–Ω—Ç–∞—Ä!");
      userLikeRef.set(true);
      const commentRef = db.ref('comments/'+key);
      commentRef.once('value').then(csnap=>{
        const data = csnap.val();
        commentRef.update({likes:(data.likes||0)+1});
        btn.innerText = `üëç ${(data.likes||0)+1}`;
        btn.classList.add('active');
      });
    });
  });
}

// --- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è / –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤ ---
function editComment(key){
  const newText = prompt("–†–µ–¥–∞–≥—É–π—Ç–µ –∫–æ–º–µ–Ω—Ç–∞—Ä:");
  if(newText !== null){
    db.ref('comments/'+key).update({text:newText});
  }
}
function deleteComment(key){
  if(confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä?")){
    db.ref('comments/'+key).remove();
    db.ref('commentLikes/'+key).remove();
  }
}

// --- –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å ---
function saveUserInDB(){
  if(!currentUserUID) return;
  db.ref('users/'+currentUserUID).set({
    name: currentUserName,
    blocked: false,
    lastLogin: Date.now()
  });
}
function loadUsers(){
  if(!isAdmin) return;
  const tbody = document.getElementById('usersTable');
  tbody.innerHTML = '';
  db.ref('users').once('value').then(snap=>{
    const users = snap.val()||{};
    Object.entries(users).forEach(([uid, u])=>{
      const tr = document.createElement('tr');
      const status = u.blocked ? '–ó–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π' : '–ê–∫—Ç–∏–≤–Ω–∏–π';
      const btnText = u.blocked ? '–†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏' : '–ë–ª–æ–∫—É–≤–∞—Ç–∏';
      tr.innerHTML = `
        <td>${uid}</td>
        <td>${u.name}</td>
        <td>${status}</td>
        <td><button onclick="toggleBlock('${uid}')">${btnText}</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}
function toggleBlock(uid){
  db.ref('users/'+uid).once('value').then(snap=>{
    if(!snap.exists()) return;
    const user = snap.val();
    const newStatus = !user.blocked;
    db.ref('users/'+uid).update({blocked:newStatus});
    showModal(`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ${user.name} ${newStatus ? '–∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–∏–π' : '—Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–∏–π'}`);
    loadUsers();
  });
}
</script>
</body>
</html>
